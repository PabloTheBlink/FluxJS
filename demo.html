<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0a0a0a" />
    <meta name="description" content="Flux.js - Demostración interactiva de la librería de partículas animadas más avanzada. Experimenta con efectos visuales espectaculares, controles en tiempo real y presets impresionantes." />
    <title>Flux.js - Demostración Interactiva</title>

    <meta name="theme-color" content="#020202" />
    <link rel="icon" href="icon.png" type="image/png" />

    <!-- Critical CSS inlined for faster loading -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0f0f1e 100%);
        color: #ffffff;
        min-height: 100dvh;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        position: relative;
      }

      .demo-container {
        position: relative;
        width: 100%;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      .control-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(15, 15, 30, 0.92);
        padding: 24px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 1000;
        max-width: 320px;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overflow-y: auto;
        max-height: calc(100dvh - 40px);
        will-change: transform;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .control-panel::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.02) 0%, rgba(102, 51, 153, 0.02) 50%, rgba(255, 0, 110, 0.02) 100%);
        border-radius: 20px;
        pointer-events: none;
      }

      .control-panel h3 {
        margin-bottom: 20px;
        color: #ffffff;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        background: linear-gradient(135deg, #00ff88, #0066cc, #ff006e);
        background-size: 200% 200%;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradientShift 3s ease-in-out infinite;
        position: relative;
        padding-bottom: 12px;
      }

      .control-panel h3::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, transparent, #00ff88, transparent);
      }

      .control-group {
        margin-bottom: 20px;
        position: relative;
      }

      .control-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 13px;
        color: #e0e0e0;
        font-weight: 500;
        letter-spacing: 0.5px;
      }

      .control-group input,
      .control-group select {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        color: #fff;
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
      }

      .control-group input:focus,
      .control-group select:focus {
        outline: none;
        border-color: #00ff88;
        box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1), 0 8px 25px rgba(0, 255, 136, 0.15);
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-1px);
      }

      .control-group input[type="range"] {
        accent-color: #00ff88;
        cursor: pointer;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 0;
      }

      .control-group input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 255, 136, 0.3);
        transition: all 0.2s ease;
      }

      .control-group input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
      }

      .control-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        accent-color: #00ff88;
        cursor: pointer;
      }

      .preset-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .preset-btn {
        padding: 14px 12px;
        background: linear-gradient(135deg, #00ff88, #0066cc);
        border: none;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        transform: translateZ(0);
        will-change: transform;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .preset-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .preset-btn:hover::before {
        left: 100%;
      }

      .preset-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      .preset-btn:active {
        transform: translateY(-1px) scale(1.02);
        transition: all 0.1s ease;
      }

      /* Ultra button special effect */
      .preset-btn:first-child {
        background: linear-gradient(135deg, #ff006e, #8b5cf6, #00ff88);
        animation: ultraGlow 3s ease-in-out infinite alternate;
        position: relative;
        overflow: hidden;
      }

      .preset-btn:first-child::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: ultraSpin 4s linear infinite;
        pointer-events: none;
      }

      @keyframes ultraGlow {
        0% {
          box-shadow: 0 2px 10px rgba(255, 0, 110, 0.4), 0 0 20px rgba(255, 0, 110, 0.2);
        }
        100% {
          box-shadow: 0 4px 25px rgba(255, 0, 110, 0.6), 0 0 40px rgba(139, 92, 246, 0.4), 0 0 60px rgba(0, 255, 136, 0.2);
        }
      }

      @keyframes ultraSpin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .content {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100dvh;
        text-align: center;
        padding: 40px 20px;
        will-change: transform;
      }

      .content::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 150%;
        height: 150%;
        background: radial-gradient(circle, rgba(0, 255, 136, 0.02) 0%, transparent 70%);
        pointer-events: none;
        z-index: -1;
      }

      .title {
        font-size: clamp(3rem, 10vw, 5rem);
        font-weight: 800;
        margin-bottom: 24px;
        background: linear-gradient(135deg, #00ff88, #0066cc, #ff006e, #8b5cf6);
        background-size: 300% 300%;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradientShift 5s ease-in-out infinite;
        text-shadow: 0 0 40px rgba(0, 255, 136, 0.2);
        line-height: 1.1;
        letter-spacing: -0.02em;
        position: relative;
      }

      .title::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #00ff88, #0066cc, #ff006e, #8b5cf6);
        background-size: 300% 300%;
        animation: gradientShift 5s ease-in-out infinite;
        filter: blur(20px);
        opacity: 0.1;
        z-index: -1;
      }

      @keyframes gradientShift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .subtitle {
        font-size: clamp(1.1rem, 4vw, 1.6rem);
        margin-bottom: 40px;
        color: rgba(255, 255, 255, 0.8);
        max-width: 700px;
        line-height: 1.6;
        font-weight: 400;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .toggle-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1001;
      }

      .toggle-btn {
        background: linear-gradient(135deg, #00ff88, #0066cc);
        border: none;
        padding: 16px 20px;
        border-radius: 50px;
        color: white;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
        box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 60px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .toggle-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .toggle-btn:hover {
        transform: scale(1.1) translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 255, 136, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.2);
      }

      .toggle-btn:hover::before {
        opacity: 1;
      }

      .toggle-btn:active {
        transform: scale(1.05) translateY(-1px);
        transition: all 0.1s ease;
      }

      /* Media Queries para Responsividad */
      @media (max-width: 1024px) {
        .control-panel {
          max-width: 300px;
          right: 15px;
          top: 15px;
          padding: 20px;
        }
      }

      @media (max-width: 768px) {
        .control-panel {
          position: fixed;
          top: auto;
          bottom: -8rem;
          left: 10px;
          right: 10px;
          max-width: none;
          border-radius: 20px 20px 0 0;
          max-height: 75vh;
          overflow-y: auto;
          transform: translateY(calc(100% - 70px));
          transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          padding: 20px 24px 24px;
          border-top: 3px solid #00ff88;
          box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .control-panel.open {
          transform: translateY(0);
        }

        .control-panel h3 {
          position: relative;
          padding-bottom: 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          margin-bottom: 24px;
          text-align: center;
        }

        .control-panel h3::after {
          content: "👆 Toca el botón ⚙️ para abrir los controles";
          position: absolute;
          top: -28px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 11px;
          color: rgba(255, 255, 255, 0.5);
          font-weight: normal;
          white-space: nowrap;
          background: rgba(0, 0, 0, 0.8);
          padding: 4px 8px;
          border-radius: 6px;
        }

        .control-panel.open h3::after {
          content: "👇 Desliza hacia abajo o toca ✕ para cerrar";
        }

        .title {
          font-size: 2.8rem;
          margin-bottom: 20px;
          line-height: 1.1;
        }

        .subtitle {
          font-size: 1.3rem;
          margin-bottom: 30px;
        }

        .content {
          padding: 140px 20px 100px;
        }

        .preset-buttons {
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
        }

        .preset-btn {
          padding: 12px 8px;
          font-size: 11px;
          min-height: 50px; /* Mejorar accesibilidad táctil */
        }

        .control-group {
          margin-bottom: 18px;
        }

        .control-group label {
          font-size: 14px;
        }

        .control-group input,
        .control-group select {
          padding: 12px;
          font-size: 15px;
        }

        .toggle-panel {
          bottom: 25px;
          right: 25px;
          z-index: 1002;
        }

        .toggle-btn {
          width: 70px;
          height: 70px;
          font-size: 22px;
          box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
      }

      @media (max-width: 480px) {
        .title {
          font-size: 2.2rem;
        }

        .subtitle {
          font-size: 1.1rem;
        }

        .content {
          padding: 120px 15px 20px;
        }

        .preset-buttons {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .preset-btn {
          font-size: 10px;
          padding: 10px 6px;
        }

        .control-panel {
          padding: 16px 20px 20px;
          left: 5px;
          right: 5px;
        }

        .control-group label {
          font-size: 13px;
        }

        .toggle-btn {
          width: 65px;
          height: 65px;
          font-size: 20px;
        }
      }

      @media (max-width: 320px) {
        .title {
          font-size: 1.8rem;
        }

        .content {
          padding: 90px 8px 12px;
        }
      }

      /* Mejoras para interacción táctil */
      @media (hover: none) and (pointer: coarse) {
        .preset-btn {
          padding: 14px 10px;
          min-height: 50px;
        }

        .control-group input[type="range"] {
          height: 50px;
        }

        .control-group input,
        .control-group select {
          min-height: 50px;
          font-size: 16px; /* Evita zoom en iOS */
        }

        .toggle-btn {
          min-width: 70px;
          min-height: 70px;
        }
      }

      /* Optimizaciones de rendimiento */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Optimizaciones para pantallas de alta densidad */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .control-panel {
          backdrop-filter: blur(25px);
          -webkit-backdrop-filter: blur(25px);
        }

        .control-group input,
        .control-group select {
          backdrop-filter: blur(15px);
        }
      }

      /* Optimizaciones para dark mode */
      @media (prefers-color-scheme: dark) {
        .control-panel {
          background: rgba(15, 15, 30, 0.95);
          border-color: rgba(255, 255, 255, 0.15);
        }
      }

      /* Mejoras de accesibilidad */
      @media (prefers-contrast: high) {
        .control-panel {
          background: rgba(0, 0, 0, 0.98);
          border: 2px solid #fff;
        }

        .control-group input,
        .control-group select {
          border: 2px solid rgba(255, 255, 255, 0.6);
          background: rgba(255, 255, 255, 0.15);
        }

        .preset-btn {
          border: 1px solid rgba(255, 255, 255, 0.3);
        }
      }

      /* Optimizaciones para touch devices */
      @media (hover: none) and (pointer: coarse) {
        .preset-btn {
          padding: 14px 12px;
          font-size: 12px;
        }

        .control-group input,
        .control-group select {
          padding: 14px;
          font-size: 16px; /* Previene zoom en iOS */
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
          width: 24px;
          height: 24px;
        }
      }

      .hidden {
        display: none;
      }

      /* Efectos adicionales para mejorar la experiencia visual */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .control-panel:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }

      /* Mejora en la accesibilidad del focus */
      *:focus-visible {
        outline: 2px solid #00ff88;
        outline-offset: 2px;
      }

      /* Smooth scrolling mejorado */
      html {
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 255, 136, 0.6) rgba(10, 10, 10, 0.3);
      }

      /* Estilos personalizados para la barra de scroll */
      /* Webkit browsers (Chrome, Safari, Edge) */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(10, 10, 10, 0.3);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.6) 0%, rgba(102, 51, 153, 0.6) 50%, rgba(255, 0, 110, 0.6) 100%);
        border-radius: 10px;
        border: 2px solid rgba(15, 15, 30, 0.5);
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.8) 0%, rgba(102, 51, 153, 0.8) 50%, rgba(255, 0, 110, 0.8) 100%);
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.5), 0 0 25px rgba(255, 0, 110, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      ::-webkit-scrollbar-thumb:active {
        background: linear-gradient(135deg, rgba(0, 255, 136, 1) 0%, rgba(102, 51, 153, 1) 50%, rgba(255, 0, 110, 1) 100%);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.7), 0 0 30px rgba(255, 0, 110, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      ::-webkit-scrollbar-corner {
        background: rgba(15, 15, 30, 0.8);
        border-radius: 10px;
      }

      /* Estilos específicos para el panel de control */
      .control-panel::-webkit-scrollbar {
        width: 8px;
      }

      .control-panel::-webkit-scrollbar-track {
        background: rgba(15, 15, 30, 0.5);
        border-radius: 8px;
        margin: 4px;
      }

      .control-panel::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.4) 0%, rgba(102, 51, 153, 0.4) 50%, rgba(255, 0, 110, 0.4) 100%);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 8px rgba(0, 255, 136, 0.2);
      }

      .control-panel::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.6) 0%, rgba(102, 51, 153, 0.6) 50%, rgba(255, 0, 110, 0.6) 100%);
        box-shadow: 0 0 12px rgba(0, 255, 136, 0.4);
      }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8463L0S5MX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-8463L0S5MX");
    </script>
    <script src="https://api.devetty.es/resources/js/analytics.js"></script>
  </head>
  <body>
    <div class="demo-container">
      <!-- Control Panel -->
      <div class="control-panel" id="control-panel">
        <h3>🎮 Controles Avanzados</h3>

        <!-- Preset Buttons -->
        <div class="preset-buttons">
          <button class="preset-btn" onclick="loadPreset('ultra')" style="background: linear-gradient(45deg, #ff0080, #7928ca, #ff0080); font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5)">🚀 ULTRA</button>
          <button class="preset-btn" onclick="loadPreset('stars')">⭐ Estrellas</button>
          <button class="preset-btn" onclick="loadPreset('network')">🕸️ Red</button>
          <button class="preset-btn" onclick="loadPreset('bubbles')">🫧 Burbujas</button>
          <button class="preset-btn" onclick="loadPreset('spiral')">🌀 Espiral</button>
          <button class="preset-btn" onclick="loadPreset('galaxy')">🌌 Galaxia</button>
          <button class="preset-btn" onclick="loadPreset('matrix')">💚 Matrix</button>
          <button class="preset-btn" onclick="loadPreset('hearts')">💝 Corazones</button>
          <button class="preset-btn" onclick="loadPreset('fireworks')">🎆 Fuegos</button>
          <button class="preset-btn" onclick="loadPreset('cosmic')">🌠 Cósmico</button>
          <button class="preset-btn" onclick="loadPreset('cyber')">🤖 Cyber</button>
          <button class="preset-btn" onclick="loadPreset('aurora')">🌌 Aurora</button>
          <button class="preset-btn" onclick="loadPreset('storm')">⚡ Tormenta</button>
        </div>

        <!-- Controls -->
        <div class="control-group">
          <label for="particle-count-slider">🔢 Partículas: <span id="count-value">500</span></label>
          <input type="range" id="particle-count-slider" min="10" max="500" value="500" />
        </div>

        <div class="control-group">
          <label for="speed-slider">⚡ Velocidad: <span id="speed-value">0.3</span></label>
          <input type="range" id="speed-slider" min="0.1" max="2.0" step="0.1" value="0.3" />
        </div>

        <div class="control-group">
          <label for="size-slider">📏 Tamaño: <span id="size-value">3</span></label>
          <input type="range" id="size-slider" min="1" max="10" value="3" />
        </div>

        <div class="control-group">
          <label for="color-type">🎨 Tipo de Color:</label>
          <select id="color-type">
            <option value="single">Simple</option>
            <option value="gradient">Gradiente</option>
            <option value="rainbow" selected>Arcoíris</option>
            <option value="random">Aleatorio</option>
          </select>
        </div>

        <div class="control-group">
          <label for="animation-type">🎭 Animación:</label>
          <select id="animation-type">
            <option value="float">Flotante</option>
            <option value="bounce">Rebote</option>
            <option value="spiral">Espiral</option>
            <option value="wave" selected>Onda</option>
            <option value="orbit">Órbita</option>
          </select>
        </div>

        <div class="control-group">
          <label for="shape-type">🔷 Forma:</label>
          <select id="shape-type">
            <option value="circle">Círculo</option>
            <option value="square">Cuadrado</option>
            <option value="triangle">Triángulo</option>
            <option value="star" selected>Estrella</option>
            <option value="heart">Corazón</option>
          </select>
        </div>

        <div class="control-group">
          <label for="connection-distance">🔗 Distancia Conexión: <span id="connection-distance-value">120</span></label>
          <input type="range" id="connection-distance" min="50" max="300" value="120" />
        </div>

        <div class="control-group">
          <label for="turbulence-slider">🌪️ Turbulencia: <span id="turbulence-value">0.3</span></label>
          <input type="range" id="turbulence-slider" min="0" max="1" step="0.1" value="0.3" />
        </div>

        <div class="control-group">
          <label for="glow-size">✨ Tamaño Glow: <span id="glow-size-value">15</span></label>
          <input type="range" id="glow-size" min="5" max="50" value="15" />
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="connections-toggle" checked /> 🔗 Conexiones </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="glow-toggle" checked /> ✨ Efecto Glow </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="pulse-toggle" checked /> 💓 Pulsación </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="rotation-toggle" checked /> 🔄 Rotación </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="twinkle-toggle" checked /> ⭐ Centelleo </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="trail-toggle" checked /> 🐭 Trail Mouse </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="physics-toggle" /> 🌍 Física (Gravedad) </label>
        </div>

        <div class="control-group">
          <label> <input type="checkbox" id="curve-connections" checked /> 〰️ Conexiones Curvas </label>
        </div>
      </div>

      <!-- Toggle Button for Mobile -->
      <div class="toggle-panel">
        <button class="toggle-btn" id="toggle-btn" onclick="toggleControlPanel()">
          <span id="toggle-icon">⚙️</span>
        </button>
      </div>
    </div>

    <script src="flux.js" defer></script>
    <script>
      // Optimizaciones globales
      "use strict";

      // Variables globales optimizadas
      let currentFlux = null;
      let isInitialized = false;
      let rafId = null;

      // Stats optimizados con requestAnimationFrame
      const stats = {
        fps: 0,
        frameCount: 0,
        lastTime: performance.now(),
        element: null,
        updateStats() {
          this.frameCount++;
          const now = performance.now();
          if (now - this.lastTime >= 1000) {
            this.fps = Math.round((this.frameCount * 1000) / (now - this.lastTime));
            this.frameCount = 0;
            this.lastTime = now;

            // Actualizar UI solo si hay cambios significativos
            if (this.element && Math.abs(this.fps - (parseInt(this.element.textContent) || 0)) > 2) {
              this.element.textContent = this.fps;
            }
          }
        },
      };

      // Cache de configuraciones para evitar recrear objetos
      const configCache = new Map();

      // Debounce optimizado para controles
      const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func.apply(this, args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      };

      // Presets optimizados con lazy loading
      const spectacularPresets = {
        ultra: {
          count: Math.min(400, window.devicePixelRatio > 1 ? 300 : 400),
          color: {
            type: "rainbow", // Colores dinámicos
            rainbowSpeed: 0.04, // Velocidad rápida del arcoíris
            randomPalette: ["#FF0080", "#7928CA", "#FF0080", "#FA00FF", "#8B5CF6", "#A855F7", "#C084FC", "#DDD6FE"],
          },
          size: {
            min: 1,
            max: 10, // Tamaños muy variados
            pulse: true,
            pulseSpeed: 0.06,
            pulseIntensity: 1.5, // Pulsación intensa
            distribution: "exponential",
          },
          speed: {
            min: 0.1,
            max: 2.0, // Velocidades muy variadas
            acceleration: 0.003, // Aceleración constante
            turbulence: 1.0, // Máxima turbulencia
            turbulenceFrequency: 0.03,
          },
          connections: {
            enabled: true,
            distance: 150, // Conexiones de larga distancia
            animated: true,
            curve: true, // Conexiones curvas
            opacity: 0.7,
            width: 2, // Líneas más gruesas
            maxConnections: 6, // Máximo número de conexiones
            animationSpeed: 0.05,
          },
          animation: {
            type: "spiral",
            speed: 2.0, // Velocidad máxima
            direction: "random",
            wave: { amplitude: 100, frequency: 0.025, speed: 0.04 },
            orbit: { radius: 150, speed: 0.02 },
          },
          effects: {
            glow: true,
            glowColor: "#FF0080",
            glowSize: 30, // Glow masivo
            shadow: true,
            shadowColor: "rgba(255,0,128,0.6)",
            shadowBlur: 15,
            twinkle: true,
            twinkleSpeed: 0.08, // Centelleo rápido
          },
          shape: {
            type: "star", // Formas estelares
            rotation: true,
            rotationSpeed: 0.05, // Rotación rápida
            sides: 8, // Estrellas de 8 puntas
          },
          physics: {
            gravity: 0,
            friction: 0,
            wind: 0.04,
            windDirection: Math.PI / 4, // Viento dinámico
            bounce: 0.95,
          },
          mouse: {
            interact: true,
            distance: 300, // Interacción de largo alcance
            attraction: 0.15, // Atracción fuerte
            trail: true,
            trailLength: 80,
            trailWidth: 20, // Trail masivo
            trailColor: "#FF0080",
            trailGlow: true,
            trailFadeTime: 3000,
            sparkles: true,
            magnetism: true,
            magnetismStrength: 0.05,
            touch: { enabled: true, multiTouch: true, touchDistance: 350, touchAttraction: 0.2 },
          },
          opacity: {
            min: 0.4,
            max: 1.0,
            fadeIn: true,
            fadeInDuration: 1000,
            flicker: true,
            flickerSpeed: 0.1, // Parpadeo rápido
          },
          canvas: {
            background: "radial-gradient(circle at 50% 50%, #1a0033 0%, #000000 70%)", // Fondo espectacular
            opacity: 1,
          },
        },

        fireworks: {
          count: 180,
          color: {
            type: "random",
            randomPalette: ["#FF6B6B", "#FFD93D", "#6BCF7F", "#4D96FF", "#9B59B6", "#FF8C42", "#FF3366", "#00D4AA"],
          },
          size: { min: 2, max: 8, pulse: true, pulseSpeed: 0.05, pulseIntensity: 1.2 },
          speed: { min: 0.3, max: 1.5, turbulence: 0.8 },
          connections: { enabled: true, distance: 80, animated: true, curve: true, opacity: 0.6 },
          animation: { type: "spiral", speed: 1.5 },
          effects: { glow: true, glowSize: 20, twinkle: true, twinkleSpeed: 0.06 },
          shape: { type: "star", rotation: true, rotationSpeed: 0.04 },
          physics: { gravity: -0.02, wind: 0.03 },
          mouse: {
            interact: true,
            distance: 150,
            attraction: 0.12,
            trail: true,
            trailLength: 60,
            trailWidth: 15,
            sparkles: true,
            magnetism: true,
          },
        },

        cosmic: {
          count: 300,
          color: {
            type: "gradient",
            gradient: ["#8B00FF", "#4B0082", "#9400D3", "#8A2BE2", "#DA70D6", "#FF69B4", "#FF1493"],
          },
          size: { min: 1, max: 5, distribution: "exponential", pulse: true },
          speed: { min: 0.05, max: 0.4, turbulence: 0.4 },
          connections: { enabled: true, distance: 100, maxConnections: 4, animated: true, opacity: 0.4 },
          animation: { type: "orbit", orbit: { radius: 200, speed: 0.008 } },
          effects: { glow: true, glowColor: "#8B00FF", glowSize: 12, twinkle: true },
          shape: { type: "circle", rotation: false },
          opacity: { min: 0.3, max: 0.9, flicker: true },
        },

        cyber: {
          count: 120,
          color: {
            type: "gradient",
            gradient: ["#00FF41", "#00D4AA", "#00BFFF", "#1E90FF", "#0080FF"],
          },
          size: { min: 1, max: 4, pulse: false },
          speed: { min: 0.4, max: 1.2, acceleration: 0.002 },
          connections: {
            enabled: true,
            distance: 150,
            animated: true,
            width: 2,
            opacity: 0.7,
            maxConnections: 5,
          },
          animation: { type: "wave", direction: "right", speed: 2 },
          effects: {
            glow: true,
            glowColor: "#00FF41",
            glowSize: 18,
            shadow: true,
            shadowColor: "rgba(0,255,65,0.5)",
          },
          shape: { type: "square", rotation: true, rotationSpeed: 0.03 },
          physics: { gravity: 0, friction: 0.01 },
        },

        aurora: {
          count: 200,
          color: {
            type: "gradient",
            gradient: ["#00FF7F", "#32CD32", "#7FFF00", "#ADFF2F", "#98FB98", "#90EE90"],
          },
          size: { min: 2, max: 6, pulse: true, pulseSpeed: 0.02, pulseIntensity: 0.6 },
          speed: { min: 0.1, max: 0.6, turbulence: 0.6 },
          connections: { enabled: true, distance: 120, curve: true, animated: true, opacity: 0.5 },
          animation: {
            type: "wave",
            wave: { amplitude: 80, frequency: 0.02, speed: 0.03 },
          },
          effects: {
            glow: true,
            glowColor: "#00FF7F",
            glowSize: 25,
            twinkle: true,
            twinkleSpeed: 0.03,
          },
          shape: { type: "circle", rotation: false },
          physics: { wind: 0.02, windDirection: Math.PI / 3 },
        },

        storm: {
          count: 150,
          color: {
            type: "random",
            randomPalette: ["#FFD700", "#FFFF00", "#FFA500", "#FF4500", "#DC143C", "#8B0000"],
          },
          size: { min: 1, max: 7, pulse: true, pulseSpeed: 0.08, pulseIntensity: 1.5 },
          speed: { min: 0.5, max: 2.0, turbulence: 1.2, acceleration: 0.005 },
          connections: {
            enabled: true,
            distance: 90,
            animated: true,
            width: 1.5,
            opacity: 0.8,
            curve: false,
          },
          animation: { type: "bounce", speed: 1.8 },
          effects: {
            glow: true,
            glowColor: "#FFD700",
            glowSize: 22,
            twinkle: true,
            twinkleSpeed: 0.1,
            shadow: true,
            shadowBlur: 10,
          },
          shape: { type: "triangle", rotation: true, rotationSpeed: 0.06 },
          physics: { gravity: 0.03, bounce: 0.95, wind: 0.05 },
          opacity: { min: 0.4, max: 1.0, flicker: true, flickerSpeed: 0.08 },
        },

        stars: {
          count: 250,
          color: {
            type: "random",
            randomPalette: ["#FFFFFF", "#FFFACD", "#F0E68C", "#FFE4B5", "#FFEFD5", "#FFF8DC"],
          },
          size: { min: 1, max: 4, pulse: true, pulseSpeed: 0.02, pulseIntensity: 0.8 },
          speed: { min: 0.05, max: 0.3, turbulence: 0.2 },
          connections: { enabled: false },
          animation: { type: "float", speed: 0.5 },
          effects: {
            glow: true,
            glowColor: "#FFFFFF",
            glowSize: 8,
            twinkle: true,
            twinkleSpeed: 0.03,
          },
          shape: { type: "star", rotation: false, sides: 5 },
          physics: { gravity: 0, friction: 0 },
          opacity: { min: 0.3, max: 0.9, flicker: true, flickerSpeed: 0.04 },
        },

        network: {
          count: 80,
          color: {
            type: "single",
            value: "#00BFFF",
          },
          size: { min: 2, max: 5, pulse: false },
          speed: { min: 0.2, max: 0.6 },
          connections: {
            enabled: true,
            distance: 200,
            animated: true,
            width: 2,
            opacity: 0.8,
            maxConnections: 8,
            curve: false,
          },
          animation: { type: "linear", speed: 1.0 },
          effects: {
            glow: true,
            glowColor: "#00BFFF",
            glowSize: 12,
          },
          shape: { type: "circle", rotation: false },
          physics: { gravity: 0, friction: 0.02 },
        },

        bubbles: {
          count: 100,
          color: {
            type: "gradient",
            gradient: ["#87CEEB", "#87CEFA", "#B0E0E6", "#ADD8E6", "#E0F6FF"],
          },
          size: { min: 3, max: 12, pulse: true, pulseSpeed: 0.04, pulseIntensity: 0.6 },
          speed: { min: 0.1, max: 0.5, turbulence: 0.3 },
          connections: { enabled: false },
          animation: { type: "float", speed: 0.8 },
          effects: {
            glow: true,
            glowColor: "#87CEEB",
            glowSize: 15,
            shadow: true,
            shadowColor: "rgba(135,206,235,0.3)",
          },
          shape: { type: "circle", rotation: false },
          physics: { gravity: -0.01, friction: 0.01, bounce: 0.8 },
          opacity: { min: 0.4, max: 0.7 },
        },

        spiral: {
          count: 120,
          color: {
            type: "rainbow",
            rainbowSpeed: 0.05,
          },
          size: { min: 2, max: 6, pulse: true, pulseSpeed: 0.04 },
          speed: { min: 0.3, max: 1.0 },
          connections: {
            enabled: true,
            distance: 100,
            animated: true,
            curve: true,
            opacity: 0.6,
          },
          animation: {
            type: "spiral",
            speed: 1.5,
            direction: "clockwise",
          },
          effects: {
            glow: true,
            glowSize: 18,
            twinkle: true,
            twinkleSpeed: 0.06,
          },
          shape: { type: "circle", rotation: true, rotationSpeed: 0.03 },
          physics: { gravity: 0, friction: 0 },
        },

        galaxy: {
          count: 300,
          color: {
            type: "gradient",
            gradient: ["#663399", "#9933CC", "#CC33FF", "#FF33CC", "#FF6699", "#FFCCFF"],
          },
          size: { min: 1, max: 8, distribution: "exponential", pulse: true },
          speed: { min: 0.05, max: 0.4 },
          connections: {
            enabled: true,
            distance: 80,
            animated: true,
            opacity: 0.3,
            maxConnections: 3,
          },
          animation: {
            type: "orbit",
            orbit: { radius: 250, speed: 0.01 },
          },
          effects: {
            glow: true,
            glowColor: "#9933CC",
            glowSize: 20,
            twinkle: true,
          },
          shape: { type: "star", rotation: true, rotationSpeed: 0.02, sides: 6 },
          physics: { gravity: 0, friction: 0 },
          opacity: { min: 0.2, max: 0.8 },
        },

        matrix: {
          count: 150,
          color: {
            type: "random",
            randomPalette: ["#00FF00", "#00CC00", "#00AA00", "#008800", "#CCFFCC"],
          },
          size: { min: 1, max: 3, pulse: false },
          speed: { min: 0.5, max: 1.5 },
          connections: {
            enabled: true,
            distance: 120,
            animated: true,
            width: 1,
            opacity: 0.7,
          },
          animation: { type: "linear", direction: "down", speed: 2.0 },
          effects: {
            glow: true,
            glowColor: "#00FF00",
            glowSize: 10,
            shadow: true,
            shadowColor: "rgba(0,255,0,0.5)",
          },
          shape: { type: "square", rotation: false },
          physics: { gravity: 0.02, friction: 0 },
          opacity: { min: 0.5, max: 1.0, flicker: true, flickerSpeed: 0.1 },
        },

        hearts: {
          count: 60,
          color: {
            type: "random",
            randomPalette: ["#FF69B4", "#FF1493", "#DC143C", "#B22222", "#FFB6C1", "#FFC0CB"],
          },
          size: { min: 4, max: 10, pulse: true, pulseSpeed: 0.06, pulseIntensity: 1.2 },
          speed: { min: 0.2, max: 0.8, turbulence: 0.4 },
          connections: { enabled: false },
          animation: { type: "float", speed: 1.2 },
          effects: {
            glow: true,
            glowColor: "#FF69B4",
            glowSize: 25,
            twinkle: true,
            twinkleSpeed: 0.05,
          },
          shape: { type: "heart", rotation: true, rotationSpeed: 0.02 },
          physics: { gravity: -0.005, friction: 0.01 },
          opacity: { min: 0.6, max: 1.0 },
        },
      };

      // Initialize with optimized configuration
      function initFlux() {
        // Cleanup previous instance
        if (currentFlux) {
          currentFlux.destroy();
          currentFlux = null;
        }

        // Clear any pending animations
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }

        // Get optimal particle count based on device capabilities
        const getOptimalParticleCount = () => {
          const baseCount = 100;
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const pixelRatio = window.devicePixelRatio || 1;
          const screenArea = window.innerWidth * window.innerHeight;

          let multiplier = 1;
          if (isMobile) multiplier *= 0.5;
          if (pixelRatio > 2) multiplier *= 0.7;
          if (screenArea < 500000) multiplier *= 0.6; // Small screens

          return Math.max(30, Math.floor(baseCount * multiplier));
        };

        const config = {
          // Configuración básica optimizada
          container: document.body,
          count: getOptimalParticleCount(),

          // Sistema de colores optimizado
          color: {
            type: "rainbow",
            rainbowSpeed: 0.03,
            value: "#00ff88",
            gradient: ["#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FECA57", "#FF8C42"],
            randomPalette: ["#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FECA57", "#FF8C42", "#FF3366", "#9B59B6"],
          },

          // Configuración de tamaño optimizada
          size: {
            min: 1,
            max: 6,
            pulse: true,
            pulseSpeed: 0.03,
            pulseIntensity: 0.8,
            distribution: "gaussian",
          },

          // Velocidad optimizada
          speed: {
            min: 0.1,
            max: 0.8,
            acceleration: 0.001,
            turbulence: 0.3,
            turbulenceFrequency: 0.02,
          },

          // Opacidad optimizada
          opacity: {
            min: 0.4,
            max: 1.0,
            fadeIn: true,
            fadeInDuration: 1500,
            flicker: true,
            flickerSpeed: 0.05,
          },

          // Conexiones optimizadas
          connections: {
            enabled: true,
            distance: 120,
            color: "#00ff88",
            opacity: 0.5,
            width: 1.5,
            maxConnections: 3,
            animated: true,
            animationSpeed: 0.03,
            curve: true,
          },

          // Mouse interaction optimizada
          mouse: {
            interact: true,
            distance: 200,
            attraction: 0.08,
            repulsion: false,
            trail: true,
            trailLength: 40,
            trailWidth: 12,
            trailColor: "#00ff88",
            trailGlow: true,
            sparkles: true,
            magnetism: false,
            touch: {
              enabled: true,
              multiTouch: false,
              touchDistance: 250,
              touchAttraction: 0.12,
            },
          },

          // Física optimizada
          physics: {
            gravity: 0,
            friction: 0,
            bounce: 0.9,
            wind: 0.01,
            windDirection: Math.PI / 6,
          },

          // Efectos optimizados
          effects: {
            glow: true,
            glowColor: "#ffffff",
            glowSize: 15,
            shadow: true,
            shadowColor: "rgba(0,255,136,0.4)",
            shadowBlur: 8,
            shadowOffset: { x: 3, y: 3 },
            twinkle: true,
            twinkleSpeed: 0.04,
          },

          // Configuración de formas
          shape: {
            type: "star",
            sides: 6,
            rotation: true,
            rotationSpeed: 0.02,
          },

          // Configuración responsive optimizada
          responsive: {
            enabled: true,
            breakpoints: {
              mobile: { width: 768, particles: 0.3, maxFPS: 30, simplifyEffects: false },
              tablet: { width: 1024, particles: 0.6, maxFPS: 45, simplifyEffects: false },
              desktop: { width: 1920, particles: 1.0, maxFPS: 60, simplifyEffects: false },
            },
            scaleWithContainer: true,
            detectDevice: true,
          },

          // Animaciones optimizadas
          animation: {
            type: "wave",
            speed: 1.2,
            direction: "random",
            wave: {
              amplitude: 60,
              frequency: 0.015,
              speed: 0.025,
            },
            orbit: {
              centerX: null,
              centerY: null,
              radius: 150,
              speed: 0.015,
            },
          },

          // Canvas optimizado
          canvas: {
            background: "black",
            blur: false,
            zIndex: 1,
            opacity: 1,
          },

          // Rendimiento optimizado
          performance: {
            maxFPS: 30,
            enableWebGL: true,
            optimizeConnections: true,
            pauseOnBlur: false,
            adaptiveQuality: true,
            mobile: {
              reducedMotion: false,
              batteryOptimization: true,
              memoryLimit: 1000,
              useTransform3d: true,
            },
          },

          // Eventos
          events: {
            onInit: () => {
              isInitialized = true;
            },
          },
        };

        // Cache configuration
        configCache.set("default", config);

        // Create FluxJS instance with error handling
        try {
          currentFlux = new FluxJS(config);

          // Setup stats monitoring
          setupStatsMonitoring();
        } catch (error) {
          console.error("Error initializing FluxJS:", error);
          // Fallback to basic configuration
          initFallbackFlux();
        }
      }

      // Fallback initialization for low-end devices
      function initFallbackFlux() {
        const fallbackConfig = {
          container: document.body,
          count: 30,
          color: { type: "single", value: "#00ff88" },
          size: { min: 2, max: 4 },
          speed: { min: 0.1, max: 0.3 },
          connections: { enabled: false },
          effects: { glow: false, shadow: false },
          performance: { maxFPS: 30 },
        };

        currentFlux = new FluxJS(fallbackConfig);
      }

      // Setup performance monitoring
      function setupStatsMonitoring() {
        stats.element = document.createElement("div");
        stats.element.style.cssText = `
          position: fixed;
          top: 10px;
          left: 10px;
          background: rgba(0,0,0,0.8);
          color: #00ff88;
          padding: 5px 10px;
          border-radius: 4px;
          font-family: monospace;
          font-size: 12px;
          z-index: 1000;
          display: none;
        `;
        document.body.appendChild(stats.element);

        const updateStats = () => {
          if (currentFlux && currentFlux.isRunning) {
            stats.updateStats();
          }
          rafId = requestAnimationFrame(updateStats);
        };
        updateStats();
      }

      // Load preset configurations optimized
      function loadPreset(presetName) {
        if (!spectacularPresets[presetName]) {
          console.warn(`Preset ${presetName} not found`);
          return;
        }

        const preset = spectacularPresets[presetName];

        // Use cached config if available
        let config = configCache.get(presetName);
        if (!config) {
          config = { ...preset, container: document.body };
          configCache.set(presetName, config);
        }

        // Destroy current instance with cleanup
        if (currentFlux) {
          currentFlux.destroy();
          currentFlux = null;
        }

        // Create new instance with error handling
        try {
          currentFlux = new FluxJS(config);
          updateControlsFromFlux();
        } catch (error) {
          console.error(`Error loading preset ${presetName}:`, error);
          // Fallback to basic preset
          loadBasicPreset();
        }
      }

      // Basic fallback preset
      function loadBasicPreset() {
        const basicConfig = {
          container: document.body,
          count: 50,
          color: { type: "single", value: "#00ff88" },
          connections: { enabled: true, distance: 100 },
        };

        currentFlux = new FluxJS(basicConfig);
        updateControlsFromFlux();
      }

      // Optimized updateControlsFromFlux function with debouncing
      const updateControlsFromFlux = debounce(() => {
        if (!currentFlux) return;

        const config = currentFlux.config;

        // Update basic controls
        const updates = [
          ["particle-count-slider", config.count],
          ["speed-slider", (config.speed.min + config.speed.max) / 2],
          ["size-slider", config.size.max],
          ["color-type", config.color.type || "single"],
          ["animation-type", config.animation.type || "float"],
          ["shape-type", config.shape.type || "circle"],
        ];

        updates.forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) element.value = value;
        });

        // Update display values
        const displayUpdates = [
          ["count-value", config.count],
          ["speed-value", ((config.speed.min + config.speed.max) / 2).toFixed(1)],
          ["size-value", config.size.max],
        ];

        displayUpdates.forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) element.textContent = value;
        });

        // Update checkboxes
        const checkboxUpdates = [
          ["connections-toggle", config.connections.enabled],
          ["glow-toggle", config.effects?.glow || false],
          ["pulse-toggle", config.size?.pulse || false],
          ["rotation-toggle", config.shape?.rotation || false],
          ["trail-toggle", config.mouse?.trail || false],
        ];

        checkboxUpdates.forEach(([id, checked]) => {
          const element = document.getElementById(id);
          if (element) element.checked = checked;
        });
      }, 100);

      // Helper functions for control configurations
      const getColorConfig = (value) => {
        const configs = {
          single: { type: value, value: "#00ff88" },
          gradient: { type: value, gradient: ["#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FECA57", "#FF8C42"] },
          rainbow: { type: value, rainbowSpeed: 0.03 },
          random: { type: value, randomPalette: ["#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FECA57", "#FF8C42"] },
        };
        return configs[value] || configs.single;
      };

      const getAnimationConfig = (value) => {
        const base = { type: value, speed: 1.2 };
        const configs = {
          wave: { ...base, wave: { amplitude: 60, frequency: 0.015, speed: 0.025 } },
          spiral: { ...base, direction: "clockwise" },
          orbit: { ...base, orbit: { radius: 150, speed: 0.015 } },
        };
        return configs[value] || base;
      };

      // Setup range slider controls
      const setupRangeControls = () => {
        const controls = [
          { id: "particle-count-slider", display: "count-value", update: (val) => ({ count: val }), parser: parseInt },
          { id: "speed-slider", display: "speed-value", update: (val) => ({ speed: { min: val * 0.5, max: val * 1.5 } }), parser: parseFloat },
          { id: "size-slider", display: "size-value", update: (val) => ({ size: { min: Math.max(1, val - 2), max: val, pulse: document.getElementById("pulse-toggle")?.checked || false } }), parser: parseInt },
          { id: "connection-distance", display: "connection-distance-value", update: (val) => ({ connections: { ...currentFlux?.config?.connections, distance: val } }), parser: parseInt },
          { id: "turbulence-slider", display: "turbulence-value", update: (val) => ({ speed: { ...currentFlux?.config?.speed, turbulence: val } }), parser: parseFloat },
          { id: "glow-size", display: "glow-size-value", update: (val) => ({ effects: { ...currentFlux?.config?.effects, glowSize: val } }), parser: parseInt },
        ];

        controls.forEach(({ id, display, update, parser }) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener(
              "input",
              debounce(
                (e) => {
                  const value = parser(e.target.value);
                  const displayElement = document.getElementById(display);
                  if (displayElement) {
                    displayElement.textContent = parser === parseFloat ? value.toFixed(1) : value;
                  }
                  if (currentFlux) {
                    currentFlux.updateConfig(update(value));
                  }
                },
                id === "particle-count-slider" ? 150 : 100
              )
            );
          }
        });
      };

      // Setup select controls
      const setupSelectControls = () => {
        const selects = [
          { id: "color-type", update: (val) => ({ color: getColorConfig(val) }) },
          { id: "animation-type", update: (val) => ({ animation: getAnimationConfig(val) }) },
          { id: "shape-type", update: (val) => ({ shape: { type: val, ...(val === "star" && { sides: 6, rotation: document.getElementById("rotation-toggle")?.checked || false, rotationSpeed: 0.02 }) } }) },
        ];

        selects.forEach(({ id, update }) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", (e) => {
              if (currentFlux) {
                currentFlux.updateConfig(update(e.target.value));
              }
            });
          }
        });
      };

      // Setup checkbox controls
      const setupCheckboxControls = () => {
        const checkboxes = [
          { id: "connections-toggle", update: (checked) => ({ connections: { ...currentFlux?.config?.connections, enabled: checked } }) },
          { id: "glow-toggle", update: (checked) => ({ effects: { ...currentFlux?.config?.effects, glow: checked } }) },
          { id: "pulse-toggle", update: (checked) => ({ size: { ...currentFlux?.config?.size, pulse: checked, pulseSpeed: 0.03, pulseIntensity: 0.8 } }) },
          { id: "rotation-toggle", update: (checked) => ({ shape: { ...currentFlux?.config?.shape, rotation: checked, rotationSpeed: 0.02 } }) },
          { id: "twinkle-toggle", update: (checked) => ({ effects: { ...currentFlux?.config?.effects, twinkle: checked, twinkleSpeed: 0.04 } }) },
          { id: "trail-toggle", update: (checked) => ({ mouse: { ...currentFlux?.config?.mouse, trail: checked, trailLength: 40, trailWidth: 12, trailColor: "#00ff88" } }) },
          { id: "physics-toggle", update: (checked) => ({ physics: { ...currentFlux?.config?.physics, gravity: checked ? 0.02 : 0 } }) },
          { id: "curve-connections", update: (checked) => ({ connections: { ...currentFlux?.config?.connections, curve: checked } }) },
        ];

        checkboxes.forEach(({ id, update }) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", (e) => {
              if (currentFlux) {
                currentFlux.updateConfig(update(e.target.checked));
              }
            });
          }
        });
      };

      // Main setup function
      const setupControlListeners = () => {
        setupRangeControls();
        setupSelectControls();
        setupCheckboxControls();
      };

      // Mobile optimization
      const optimizeForMobile = () => {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
          // Add mobile-specific optimizations
          document.body.classList.add("mobile-device");

          // Reduce particle count for mobile
          if (currentFlux) {
            const currentCount = currentFlux.config.count;
            currentFlux.updateConfig({
              count: Math.floor(currentCount * 0.6),
              performance: { maxFPS: 30 },
            });
          }
        }
      };

      // Initialize everything when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize FluxJS
        initFlux();

        // Setup control listeners
        setupControlListeners();

        // Mobile optimizations
        optimizeForMobile();

        // Setup mobile panel controls
        setupMobileControls();

        // Setup keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            const panel = document.getElementById("control-panel");
            panel.classList.toggle("open");
            updateToggleIcon();
          }
        });
      });

      // Mobile control panel functions
      const toggleControlPanel = () => {
        const panel = document.getElementById("control-panel");
        panel.classList.toggle("open");
        updateToggleIcon();
      };

      const updateToggleIcon = () => {
        const panel = document.getElementById("control-panel");
        const icon = document.getElementById("toggle-icon");
        if (panel && icon) {
          icon.textContent = panel.classList.contains("open") ? "✕" : "⚙️";
        }
      };

      const setupMobileControls = () => {
        const isMobile = window.innerWidth <= 768;
        const panel = document.getElementById("control-panel");
        const toggleBtn = document.getElementById("toggle-btn");

        if (isMobile && panel && toggleBtn) {
          // Asegurar que el botón sea visible en móviles
          toggleBtn.style.display = "flex";

          // Cerrar el panel por defecto en móviles
          panel.classList.remove("open");
          updateToggleIcon();

          // Añadir event listeners para gestos táctiles
          let startY = 0;
          let currentY = 0;
          let isDragging = false;

          panel.addEventListener("touchstart", (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
          });

          panel.addEventListener("touchmove", (e) => {
            if (!isDragging) return;
            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;

            // Solo permitir deslizar hacia abajo cuando el panel está abierto
            if (panel.classList.contains("open") && deltaY > 50) {
              panel.classList.remove("open");
              updateToggleIcon();
              isDragging = false;
            }
          });

          panel.addEventListener("touchend", () => {
            isDragging = false;
          });

          // Hacer que el botón de toggle sea global
          window.toggleControlPanel = toggleControlPanel;
        } else if (toggleBtn) {
          // Ocultar el botón en desktop
          toggleBtn.style.display = "none";
        }
      };

      // Actualizar controles cuando cambie el tamaño de la pantalla
      window.addEventListener("resize", () => {
        setupMobileControls();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (currentFlux) {
          currentFlux.destroy();
        }
        if (rafId) {
          cancelAnimationFrame(rafId);
        }
      });
    </script>
  </body>
</html>
